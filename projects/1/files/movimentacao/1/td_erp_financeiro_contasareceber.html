<input id="entidadeprincipalid" name="entidadeprincipalid" type="hidden" value="80" /><input id="funcionalidadetd" name="funcionalidadetd" type="hidden" value="movimentacao" /><script type="text/javascript" src="http://localhost/searadejesus.org.br/miles/core/system/funcoes.js?nocahe=8848264c025ea42b91bfc5c00e751837"></script><script type="text/javascript" src="http://localhost/searadejesus.org.br/miles/projects/1/files/movimentacao/1/td_erp_financeiro_contasareceber.js?nocahe=8848264c025ea42b91bfc5c00e751837"></script><script type="text/javascript" src="http://localhost/searadejesus.org.br/miles/core/system/formulario.js?nocahe=8848264c025ea42b91bfc5c00e751837"></script><script type="text/javascript" src="http://localhost/searadejesus.org.br/miles/core/system/validar.js?nocahe=8848264c025ea42b91bfc5c00e751837"></script><script type="text/javascript">
			$("#salvar-movimentacao-historico").click(function(){
				$.ajax({
					url:"index.php?controller=gerarmovimentacao",
					data:{
						op:"salvarstatus",
						movimentacao:getCookie("movimentacaoselecionada"),
						id:getCookie("idmovdados")
					}
				});
				atribuiValoresCKEditor();
				var dadosHistorico = [];
				$("#form-movimentacao").find(".form-control[data-entidade]").each(function(){
					if ($(this).attr("id") != "" && $(this).attr("atributo") != undefined){
						dadosHistorico.push({
							entidade:$(this).data("entidade"),
							atributo:$(this).attr("atributo"),
							valor:$(this).val()
						});
					}
				});
				$.ajax({
					url:"index.php?controller=gerarmovimentacao",
					data:{
						op:"salvarhistorico",
						dadoshistorico:dadosHistorico,
						entidadepai:getCookie("entidademovdados"),
						identidadepai:getCookie("idmovdados")
					}
				});
			});

			$("#form-movimentacao .form-group .form-control").each(function(){
				if ($(this).prop("tagName") == "SELECT"){
					carregarListas($(this).attr("id"),$(this).attr("atributo"),"#form-movimentacao","");
				}
				$("#" + $(this).attr("id") + "-old").attr("disabled","disabled");
			});
			setTimeout(function(){
				$.ajax({
					url:"index.php?controller=gerarmovimentacao",
					data:{
						op:"retorna_dados",
						atributos:"512,510",
						id:getCookie("idmovdados")
					},
					complete:function(ret){
						var retorno = JSON.parse(ret.responseText);
						for(a in retorno){
							var atributo = td_atributo[retorno[a].atributo];
							console.log("campos => #form-movimentacao #" + atributo.nome + "-old,#form-movimentacao #" + atributo.nome);
							$("#form-movimentacao #" + atributo.nome + "-old,#form-movimentacao #" + atributo.nome).val(retorno[a].valor);
						}
					}
				});
			},500);			
			$("#td_motivo,#observacao").css("width","98%");
			$("#salvar-movimentacao-alterar").click(function(){
				var atributosID = "512,510";
				var atributosArrayID = atributosID.split(",");
				var dadosAlterar = [];
				var obrigatorio = true;
				for (a in atributosArrayID){
					var idatributo = td_atributo[atributosArrayID[a]].nome;
					$("#form-movimentacao #" + idatributo + "[required]").each(function(){
						if ($(this).val() == ""){
							obrigatorio = false;
							statusFormControl($(this),"error");
						}else{
							statusFormControl($(this),"success");
						}
					});
					dadosAlterar.push({
						entidade:$("#" + idatributo).data("entidade"),
						atributo:$("#" + idatributo).attr("atributo"),
						valor:$("#form-movimentacao #" + idatributo).val()
					});
				}
				if (!obrigatorio){
					return false;
				}
				$.ajax({
					url:"index.php?controller=gerarmovimentacao",
					data:{
						op:"salvaralterar",
						dadosalterar:dadosAlterar,
						entidadepai:getCookie("entidademovdados"),
						identidadepai:getCookie("idmovdados"),
						entidademotivo:"0",
						motivo:$("#td_motivo").val(),
						observacao:$("#observacao").val(),
						movimentacao:1
					},
					error:function(erro){
						console.log(erro);
						abrirAlerta("Erro ao Salvar","alert-danger",".msg-retorno-form-td_erp_financeiro_contasareceber");
					},
					complete:function(ret){
						if (parseInt(ret.responseText) == 1){
							abrirAlerta("Salvo com Sucesso","alert-success",".msg-retorno-form-td_erp_financeiro_contasareceber");
							for (a in atributosArrayID){
								var idatributo = td_atributo[atributosArrayID[a]].nome;
								$("#form-movimentacao #" + idatributo + "-old").val($("#" + idatributo).val());
							}
						}
					}
				});
			});
			$(".coluna[data-ncolunas=2]").css("width","50%");			
		</script><div class="row"><div class="col-md-12" id="crud-contexto-add-td_erp_financeiro_contasareceber"><div class="form-grupo-botao"><div class="loader-salvar"></div><button class="btn btn-success b-salvar b-movimentacao" id="salvar-movimentacao-alterar"><span class="fas fa-check"></span> Salvar</button><div class="retorno msg-retorno-form-td_erp_financeiro_contasareceber" style="display:none"><div role="alert" class="alert alert-dismissible alert-success" style="text-align:right;font-weight:bold"><strong></strong><button class="close" aria-label="Close" onclick="fecharAlerta();"><span aria-hidden="true">&times;</span></button></div></div></div><form class="form-horizontal tdform" id="form-movimentacao"><fieldset><div class="row-fluid form_campos"><div class="coluna" data-ncolunas="2"></div><div class="coluna" data-ncolunas="2"><div class="form-group"><label for="pago" class="control-label">Pago<small> <small>( Novo )</small> </small></label><input id="pago" name="pago" type="hidden" class="form-control checkbox-sn  gd" atributo="512" data-entidade="td_erp_financeiro_contasareceber" value="0" /><br /><div class="btn-group" data-toggle="buttons"><label class="btn btn-default checkbox-s " onclick="$('#pago[data-entidade=td_erp_financeiro_contasareceber]').val(1);">Sim<input type="radio" name="checkpago" data-entidade="td_erp_financeiro_contasareceber" autocomplete="off" value="1" /></label><label class="btn btn-default checkbox-n  active" onclick="$('#pago[data-entidade=td_erp_financeiro_contasareceber]').val(0);">Não<input type="radio" name="checkpago" data-entidade="td_erp_financeiro_contasareceber" autocomplete="off" value="0" checked="true" /></label></div></div></div><div class="coluna" data-ncolunas="2"><div class="form-group"><label for="datarecebimento" class="control-label">Data de Recebimento<small> <small>( Novo )</small> </small></label><div class="input-group calendar-picker-group "><input type="text" id="datarecebimento" name="datarecebimento" data-entidade="td_erp_financeiro_contasareceber" atributo="510" class="form-control input-sm formato-data formato-calendario " value="" /><span class="input-group-btn"><button class="btn btn-default"><span class="fas fa-calendar-alt calendar-icon" aria-hidden="true"></span></button></span></div></div></div></div></fieldset></form></div></div><script type="text/javascript">
	
		$(".b-salvar.b-movimentacao").click(function(){		
			salvarStatus();
		});
		if ($("#form-movimentacao fieldset").length <= 0){
			var fieldset = $("<fieldset>");
			$("#form-movimentacao").append(fieldset);
		}

		var motivo = $("");
		$("#form-movimentacao fieldset").append(motivo);
		var observacao = $("<label for='observacao' class='control-label'>Observação</label><textarea class='form-control input-sm' required='true' id='observacao' name='observacao' data-entidade=''></textarea>");
		$("#form-movimentacao fieldset").append(observacao);
		$("#form-movimentacao fieldset").css("margin-bottom","15px");
		
		unLoaderGeral();

		function carregarListaMotivo(){
			$.ajax({
				url:config.urlrequisicoes,
				data:{
					op:"carregar_options",
					entidade:""
				},
				complete:function(ret){
					$("#td_motivo").html(ret.responseText);
				}
			});
		}

		function salvarStatus(){
			if (0 <= 0) return false;
			$.ajax({
				url:"index.php?controller=gerarmovimentacao",
				data:{
					op:"salvarstatus",
					movimentacao:getCookie("movimentacaoselecionada"),
					id:getCookie("idmovdados"),
					entidademotivo:"0",
					motivo:$("#td_motivo").val(),
					observacao:$("#observacao").val(),
				},
				complete:function(ret){
					if (parseInt(ret.responseText) == 1){
						abrirAlerta("Salvo com Sucesso","alert-success",".msg-retorno-form-td_erp_financeiro_contasareceber");	
					}else{
						abrirAlerta("Erro ao salvar. Entrar em contato com o administrador do sistema.","alert-danger",".msg-retorno-form-td_erp_financeiro_contasareceber");
						console.log("Erro ao Salvar Status");
						console.log(ret.responseText);
					}
				}
			});
		}
		$("#modal-movimentacao .modal-header .modal-title").html("Baixa de Mensalidade");
	</script>